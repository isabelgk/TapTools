/** @file
 *
 * @ingroup dspFilterLib
 *
 * @brief Unit test for the FilterLib #TTHilbert9 class.
 *
 * @details Currently this test is just a stub
 *
 * @authors Trond Lossius, Tim Place
 *
 * @copyright Copyright Â© 2012 by Trond Lossius & Timothy Place @n
 * This code is licensed under the terms of the "New BSD License" @n
 * http://creativecommons.org/licenses/BSD/
 */


#include "TTHilbert9.h"


TTErr TTHilbert9::test(TTValue& returnedTestInfo)
{
	int					errorCount = 0;
	int					testAssertionCount = 0;
	int					badSampleCount = 0;
	TTAudioSignalPtr	input = NULL;
	TTAudioSignalPtr	outputReal = NULL;
	TTAudioSignalPtr	outputImaginary = NULL;
	
	// create audio signal objects - hilbert returns real and imaginary signal so we need two channels for output
	TTObjectBaseInstantiate(kTTSym_audiosignal, &input, 1);
	TTObjectBaseInstantiate(kTTSym_audiosignal, &outputReal, 1);
	TTObjectBaseInstantiate(kTTSym_audiosignal, &outputImaginary, 1);
	input->allocWithVectorSize(128);
	outputReal->allocWithVectorSize(128);
	outputImaginary->allocWithVectorSize(128);
	
	// create an impulse
	input->clear();						// set all samples to zero
	input->mSampleVectors[0][0] = 1.0;	// set the first sample to 1
	
	// setup the filter
	//this->setAttributeValue(TT("linearGain"), 0.5);
	//this->setAttributeValue(TT("delayInSamples"), 1);

	TTObject inputArray(kTTSym_audiosignalarray, 1);
	TTObject outputArray(kTTSym_audiosignalarray, 2);

	// TODO: switch these to use the new TTBASE macro:
	((TTAudioSignalArrayPtr)inputArray.instance())->setSignal(0, input);
	((TTAudioSignalArrayPtr)outputArray.instance())->setSignal(0, outputReal);
	((TTAudioSignalArrayPtr)outputArray.instance())->setSignal(1, outputImaginary);
		
	this->process(TTAudioSignalArrayPtr(inputArray.instance()), TTAudioSignalArrayPtr(outputArray.instance()));
	
	/// The following values are not necsessarily to be trusted. They were calculated from this filter unit itself at a time when the filter was assumed to work. As such, if this test fails in the future, it should be considered an indication that something has changed in the code or compiler that causes the calculated impulse response to differ from earlier results, but this test is not able to say anything meaningful about whether the old or new behaviour is to be trusted (or eventually none of them).
	TTFloat64 expectedImpulseResponseCh1[128] = {
		1.7420609006175897e-02,
		0.0000000000000000e+00,
		-4.3505920836946033e-01,
		0.0000000000000000e+00,
		8.0706423584914044e-01,
		0.0000000000000000e+00,
		3.6492490730992394e-01,
		0.0000000000000000e+00,
		1.4751919086999823e-01,
		0.0000000000000000e+00,
		5.8960238068315345e-02,
		0.0000000000000000e+00,
		2.3536102363706037e-02,
		0.0000000000000000e+00,
		9.3940174253356358e-03,
		0.0000000000000000e+00,
		3.7494000604139655e-03,
		0.0000000000000000e+00,
		1.4964820197642804e-03,
		0.0000000000000000e+00,
		5.9728436681720997e-04,
		0.0000000000000000e+00,
		2.3839150972818700e-04,
		0.0000000000000000e+00,
		9.5148165510533045e-05,
		0.0000000000000000e+00,
		3.7976073091935286e-05,
		0.0000000000000000e+00,
		1.5157224731653196e-05,
		0.0000000000000000e+00,
		6.0496371230651281e-06,
		0.0000000000000000e+00,
		2.4145653289898111e-06,
		0.0000000000000000e+00,
		9.6371494841091791e-07,
		0.0000000000000000e+00,
		3.8464335201036664e-07,
		0.0000000000000000e+00,
		1.5352102661656153e-07,
		0.0000000000000000e+00,
		6.1274179029013311e-08,
		0.0000000000000000e+00,
		2.4456096330419825e-08,
		0.0000000000000000e+00,
		9.7610552634181111e-09,
		0.0000000000000000e+00,
		3.8958874943991041e-09,
		0.0000000000000000e+00,
		1.5549486156377259e-09,
		0.0000000000000000e+00,
		6.2061987178780377e-10,
		0.0000000000000000e+00,
		2.4770530767664106e-10,
		0.0000000000000000e+00,
		9.8865541115251806e-11,
		0.0000000000000000e+00,
		3.9459773033088236e-11,
		0.0000000000000000e+00,
		1.5749407430114503e-11,
		0.0000000000000000e+00,
		6.2859924255457196e-12,
		0.0000000000000000e+00,
		2.5089007919411533e-12,
		0.0000000000000000e+00,
		1.0013666510672705e-12,
		0.0000000000000000e+00,
		3.9967111218210333e-13,
		0.0000000000000000e+00,
		1.5951899111342436e-13,
		0.0000000000000000e+00,
		6.3668120487653824e-14,
		0.0000000000000000e+00,
		2.5411579763240305e-14,
		0.0000000000000000e+00,
		1.0142413206445196e-14,
		0.0000000000000000e+00,
		4.0480972300305685e-15,
		0.0000000000000000e+00,
		1.6156994248043121e-15,
		0.0000000000000000e+00,
		6.4486707778342382e-16,
		0.0000000000000000e+00,
		2.5738298945009473e-16,
		0.0000000000000000e+00,
		1.0272815211155196e-16,
		0.0000000000000000e+00,
		4.1001440144902600e-17,
		0.0000000000000000e+00,
		1.6364726313099775e-17,
		0.0000000000000000e+00,
		6.5315819726384476e-18,
		0.0000000000000000e+00,
		2.6069218787451070e-18,
		0.0000000000000000e+00,
		1.0404893807272607e-18,
		0.0000000000000000e+00,
		4.1528599695796719e-19,
		0.0000000000000000e+00,
		1.6575129209759770e-19,
		0.0000000000000000e+00,
		6.6155591648335443e-20,
		0.0000000000000000e+00,
		2.6404393298872762e-20,
		0.0000000000000000e+00,
		1.0538670550898157e-20,
		0.0000000000000000e+00,
		4.2062536988914454e-21,
		0.0000000000000000e+00,
		1.6788237277167869e-21,
		0.0000000000000000e+00,
		6.7006160600528881e-22,
		0.0000000000000000e+00,
		2.6743877181972321e-22,
		0.0000000000000000e+00,
		1.0674167275281468e-22,
		0.0000000000000000e+00,
		4.2603339166354575e-23,
		0.0000000000000000e+00,
		1.7004085295970599e-23,
		0.0000000000000000e+00,
		6.7867665401445153e-24,
		0.0000000000000000e+00,
		2.7087725842765494e-24,
		0.0000000000000000e+00,
		1.0811406094384403e-24,
		0.0000000000000000e+00,
		4.3151094490610365e-25,
		0.0000000000000000e+00
	};
	TTFloat64 expectedImpulseResponseCh2[128] = {
		0.0000000000000000e+00,
		1.3088561157231265e-01,
		0.0000000000000000e+00,
		-8.0318229350905646e-01,
		0.0000000000000000e+00,
		2.4061706763854041e-01,
		0.0000000000000000e+00,
		3.2748856429240580e-01,
		0.0000000000000000e+00,
		2.7115156377578087e-01,
		0.0000000000000000e+00,
		2.0771812898972941e-01,
		0.0000000000000000e+00,
		1.5647053596965757e-01,
		0.0000000000000000e+00,
		1.1741317279214779e-01,
		0.0000000000000000e+00,
		8.8026322157452805e-02,
		0.0000000000000000e+00,
		6.5980841307707747e-02,
		0.0000000000000000e+00,
		4.9454073881787727e-02,
		0.0000000000000000e+00,
		3.7066483763912313e-02,
		0.0000000000000000e+00,
		2.7781747650721667e-02,
		0.0000000000000000e+00,
		2.0822720437544736e-02,
		0.0000000000000000e+00,
		1.5606852020098936e-02,
		0.0000000000000000e+00,
		1.1697502379486035e-02,
		0.0000000000000000e+00,
		8.7674029766002318e-03,
		0.0000000000000000e+00,
		6.5712621653267744e-03,
		0.0000000000000000e+00,
		4.9252311707943894e-03,
		0.0000000000000000e+00,
		3.6915133612201298e-03,
		0.0000000000000000e+00,
		2.7668286874658961e-03,
		0.0000000000000000e+00,
		2.0737676493775997e-03,
		0.0000000000000000e+00,
		1.5543109998395106e-03,
		0.0000000000000000e+00,
		1.1649726935158236e-03,
		0.0000000000000000e+00,
		8.7315947501983486e-04,
		0.0000000000000000e+00,
		6.5444235136189995e-04,
		0.0000000000000000e+00,
		4.9051153140880911e-04,
		0.0000000000000000e+00,
		3.6764363116830850e-04,
		0.0000000000000000e+00,
		2.7555282778045581e-04,
		0.0000000000000000e+00,
		2.0652978716512792e-04,
		0.0000000000000000e+00,
		1.5479628109807555e-04,
		0.0000000000000000e+00,
		1.1602146581711255e-04,
		0.0000000000000000e+00,
		8.6959327671592014e-05,
		0.0000000000000000e+00,
		6.5176944764819235e-05,
		0.0000000000000000e+00,
		4.8850816153033016e-05,
		0.0000000000000000e+00,
		3.6614208404956519e-05,
		0.0000000000000000e+00,
		2.7442740217930922e-05,
		0.0000000000000000e+00,
		2.0568626865817874e-05,
		0.0000000000000000e+00,
		1.5416405496883087e-05,
		0.0000000000000000e+00,
		1.1554760558143691e-05,
		0.0000000000000000e+00,
		8.6604164364401853e-06,
		0.0000000000000000e+00,
		6.4910746073142995e-06,
		0.0000000000000000e+00,
		4.8651297390774720e-06,
		0.0000000000000000e+00,
		3.6464666961899777e-06,
		0.0000000000000000e+00,
		2.7330657309344397e-06,
		0.0000000000000000e+00,
		2.0484619528852104e-06,
		0.0000000000000000e+00,
		1.5353441100677822e-06,
		0.0000000000000000e+00,
		1.1507568070764773e-06,
		0.0000000000000000e+00,
		8.6250451631614136e-07,
		0.0000000000000000e+00,
		6.4645634602472670e-07,
		0.0000000000000000e+00,
		4.8452593512271245e-07,
		0.0000000000000000e+00,
		3.6315736282919755e-07,
		0.0000000000000000e+00,
		2.7219032174955979e-07,
		0.0000000000000000e+00,
		2.0400955298536579e-07,
		0.0000000000000000e+00,
		1.5290733866571095e-07,
		0.0000000000000000e+00,
		1.1460568329125052e-07,
		0.0000000000000000e+00,
		8.5898183548725818e-08,
		0.0000000000000000e+00,
		6.4381605912329973e-08,
		0.0000000000000000e+00,
		4.8254701189336697e-08,
		0.0000000000000000e+00,
		3.6167413873505584e-08,
		0.0000000000000000e+00,
		2.7107862945103133e-08,
		0.0000000000000000e+00,
		2.0317632773539256e-08,
		0.0000000000000000e+00,
		1.5228282744249575e-08,
		0.0000000000000000e+00,
		1.1413760546003468e-08
	};
	
	
	
	// TEST 1: IMPULSE RESPONSE - REAL VECTOR
	
	//TTTestLog("\nRESULTING VALUES - CHANNEL 1");
	for (int i=0; i<128; i++) {
		TTBoolean result = !TTTestFloatEquivalence(outputReal->mSampleVectors[0][i], expectedImpulseResponseCh1[i]);
		//TTTestLog("%.16e,", outputReal->mSampleVectors[0][i]);
		badSampleCount += result;
		if (result)
			TTTestLog("BAD SAMPLE @ i=%i  ( value=%.10f   expected=%.10f )", i, outputReal->mSampleVectors[0][i], expectedImpulseResponseCh1[i]);
	}
	
	TTTestAssertion("Produces correct impulse response for real signal",
					badSampleCount == 0,
					testAssertionCount,
					errorCount);
	if (badSampleCount)
		TTTestLog("badSampleCount is %i", badSampleCount);

	
	
	// TEST 2: IMPULSE RESPONSE - IMAGINARY VECTOR
	
	//TTTestLog("\nRESULTING VALUES - CHANNEL 2");
	badSampleCount = 0;
	for (int i=0; i<128; i++) {
		TTBoolean result = !TTTestFloatEquivalence(outputImaginary->mSampleVectors[0][i], expectedImpulseResponseCh2[i]);
		//TTTestLog("%.16e,", outputImaginary->mSampleVectors[0][i]);
		badSampleCount += result;
		if (result)
			TTTestLog("BAD SAMPLE @ i=%i  ( value=%.10f   expected=%.10f )", i, outputImaginary->mSampleVectors[0][i], expectedImpulseResponseCh2[i]);
	}
	
	TTTestAssertion("Produces correct impulse response for imaginary signal",
					badSampleCount == 0,
					testAssertionCount,
					errorCount);
	if (badSampleCount)
		TTTestLog("badSampleCount is %i", badSampleCount);
	
	
	
	TTObjectBaseRelease(&input);
	TTObjectBaseRelease(&outputReal);
	TTObjectBaseRelease(&outputImaginary);
	
	// Wrap up the test results to pass back to whoever called this test
	return TTTestFinish(testAssertionCount, errorCount, returnedTestInfo);
}

